# HTTP/2 性能

## 延迟

![Image text](/images2/1648626095(1).png)

## 丢包

1. 对于包含很多小型资惊（ 365 个，每个 阻）的 Web 页面， h2 加载页面的时间比 hl 更
短。这是因为 hl 下（有 TCP 连接）服务器只能井行发送 个资源（由于队头阻塞），
而 h2 下多个流（stream ）可以共用连接。
2. 对于包含少量大型资源的 Web 页面（ 10 个，每个 435阻），在所有网络条件下， hl 性
能上都比 h2 表现要好。这个多少令人感到意外的结果是初始拥塞窗口（见图 3-4 ）导致的。
如果开启 个连接， hl 的初始拥塞窗口大小实际上是 h2 倍。
3. 对于包含 些极大型资掘的 Web 页面，两者没有任何差异。 h2 的初始拥塞窗口劣势被
整体下载时长掩盖了 多路复用此时也不再具有优势。

## 服务端推送

服务端推送让服务器具备了在客户端请求之前就推送资源的能力。测试表明，如果合理使用推送，页面谊染时间可以减少 20% 50%。

尽管如此，推送也会浪费带宽，这是因为服务端可能试图推送那些在客户端已经缓存的资
掘，导致客户端收到并不需要的数据。客户端确实可以发送 RST_STREAM 帧来拒绝服务
器的 PUSH_PROMISE 帧，但是 RST_ST AM 并不会即刻到达，所以服务器还是会发送
一些多余的信息。

## 首字节时间

首字节时间（TTFB ）用于测量服务器的响应能力。

与 h1 不同，通过 的多路复用，客户端 旦加载了 HTML ，就会向服务器并行发送大盐
请求。相比 hl ，这些请求获得响应的时间之和 般会更短；但是因为是请求是同时发出
的，而单个请求的计时起点更早，所以 h2 统计到的甘FB 值反而更高。既然 hl h2
议的运行机制不同， TTFB 的意义也会随之变化。

HπP/2 hl 确实做了更多的工作，其目的就是为了从总体上提升性能。下面是一些
没有，但 h2 实现了的事情：

* 窗口大小调节
* 依赖树构建
* 维持首部信息的静态/动态表
* 压缩/解压缩首部
* 优先级调整
* 预先推送客户端尚未请求的数据流

## HTTP/2 反模式

hi 下的一些性能调优办法在 h2 下会起到反作用。本节将回顾变
通方桂的共同之处，井详细描述在 h2 中它们对性能的影响。

### 域名拆分

域名拆分是为了利用浏览器对每个域名开启多个连接的能力，以便实现资源的并行下载，
绕过 hl 的串行化下载的限制。对于包含大量小型资源的网站，普遍的做陆是拆分域名，
以利用现代浏览器针能对每个域名开启 个连接的特性。这样实际上做到了让浏览器并行
发送多个请求，以及充分利用可用带宽的效果。因为 HπP/2 采取多路复用，所以域名拆
分就不是必要的了，并且反而会让协议力图实现的目标落空。

### 资源内联

使用 h2 时的 般原则是避免内联，但是内联也井不 定毫无价值（更多信息参见下面的
附注栏“性能优化因人而异”）

### 资源合并

资源合并意味着把几个小文件合并成 个大文件。它与内联很相似，旨在省掉那些加载外
部资糠的请求响应时间，以及解码 ／执行那些资源所悄耗的 PU 资掘。之前针对资源内联
的规则同样适用于资漉合井，我们可以使用它来合井非常小的文件（ KB 或更小），以及
对初始渲染很关键的最简化 JavaScript/CSS 资惊。

### 禁用 cookie 的域名

通过禁用 cookie 的域名来提供静态资源是 项标准的性能优化最佳实践。尤其是使用 hl
时，你无能压缩首部，而且有些网站使用的 cookie 大小常常超过单个 TCP 数据包的限度。
不过，在 h2 下请求首部使用 HPACK 算桂被压缩，会显著减少巨型 cookie （尤其是当它
们在先后请求之间保持不变）的字节数。与此同时，禁用 cookie 的域名需要额外的主机名
称，这意味 将开启更多的连接

### 生成精灵图

目前，生成精 图仍是 种避免小资源请求过多的技术（你能看到人们乐意做什么来优化
hl 为了生成精灵图，开发者把较小的图片拼合成较大的图片，然后用 css 选择图片中
某个部分展示出来。依据设备及其硬件图形处理能力的不同，精灵图要么非常高效，要么
非常低效 如果用旧，最佳实践就是避免生成精灵固 要原因在于，多路复用和首部压缩去掉了大量的请求开销。即使如此，还是有些场景适合使用精灵图。