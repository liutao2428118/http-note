# Web 优化 “黑魔法” 的动机与方式

## 当前的性能挑战

现在 Web 页面每个页面会引用数百个对象，关联十多个域名，网络环境相差迥异，设备的处理能力也参差不齐。

### 剖析 Web 页面请求

浏览器请求 web 页面时，会执行重复流程，获取在屏幕绘制页面需要的所用信息。

![Image text](/images2/1648542477(1).png)

![Image text](/images2/1648542567(1).png)

### 关键性能指标

1. 延迟，延迟是指 IP 数据包从一个网络断点到另一个网络端点所花费的时间。与之相关的是往返时延（RTT）
2. 带宽，只要带宽没有饱和，两个网络端点之间的连接会一次处理尽可能多的数据量。
3. DNS查询，客户端在获取 web 页面前，需要通过域名系统把主机名称转换成 IP 地址。
4. 建立连接时间，客户端月服务器的 TCP 连接时间，三次握手。
5. TSL 协商时间，在客户端发起 HTTPS 连接时，需要一个传输层安全协议（TLS）协商的过程。
6. 首字节时间（TTFB），TTFB 是指客户端从开始定位到 web 页面，至接收到主体页面响应的第一个字节耗费的时间。
7. 内容下载时间，等同于请求资源的最后字节到达时间（TTLB）
8. 开始渲染时间，客户端的屏幕上什么时候开始显示内容
9. 文档加载完成时间（又叫页面加载时间），客户端浏览器认为页面加载完毕的时间。
10. 更多的字节，web 页面引用的内容每年都在增长，图片越来越多...
11. 更多的资源，页面引用的资源不仅变大，而且数量也增多了。
12. 更多的复杂度，随着我们添加更多、更丰富的功能。
13. 更多的域名，web 页面并不时从单元的域名拉取资源了。
14. 更多的 TCP socket, 为了应对，某些方面的增加，客户端会对一个域名开启多个 socket

### HTTP/1 的问题

1. 队头阻塞，h1 有个特性叫管道化，允许一次发送一组请求，但是只能按照发送顺序依次接收响应。请求应答过程，如果出现任何状况，剩下所有的工作都会被阻塞在那次请求应答之后。

2. 低效的 TCP 利用

传输控制协议（TCP）的设计思路是：对假设情况很保守，并能够公平对待同一个网络的不同流量的应用。它的拥塞机制设计成即使在最差的网络状况下仍能起作用，并且保证公平。涉及的核心概念就是拥护窗口。拥护窗口是指，在接收方确认数据包之前，发送方可以发送的 tcp 包的数量。如果拥塞窗口指定为 1，那么发送方发出 1个数据包之后，只能接收方确认了那个包，才能发送下一个。

TCP 有个概念 叫慢启动（ Slow Start), 
它用来探索 前连接对应拥塞窗口的合适大小。慢启动的设计目标是为了让新连接搞清楚
当前网络状况，避免给已经拥堵的网络继续添乱。它允许发送者在收到每个确认回复后额
外发送 确认包 这意味着新连接在收到 个确认回复之后，可以发送 个数据包
在收到 个确认回复之后，可以发 ；以此类推。这种几何级数增长很快就会到达协议
规定的发包数上限，这时候连接将进入拥塞避免阶段，如 3-4 所示。

![Image text](/images2/1648557342(1).png)

这种机制需要几次往返数据请求才能得知最佳拥塞窗口大小。但在解决性能问题时，就这
区区几次数据往返也是非常 贵的时间（成本）。现代操作系统 般会取 10 个数据包作
为初始拥塞窗口大小。如果你把 个数据包设置为最大值下限 1460 字节（也就是最大有
效负载），那么只能先发送 5840 字节（假定拥塞窗口为 ），然后就需要等待接收确认回
复。 如今的 Web 页面平均大小约 2MB ，包括 HTML 和所有依赖的资源。

3. 腕肿的消息首部

虽然 hl 提供了压缩被请求内容的机制，但是消息首部却无怯压缩。？肖息首部可不能忽略，
尽管它比响应资惊小很多，但它可能占据请求的绝大部分（有时候可能是全部） 如果算
上 cookie ，有个几千字节就很正常了。

4. 受限的优先级设置

如果浏览器针对指定域名开启了多个 socket （每个都会受队头阻塞问题的困扰），开始请
求资源，这时候浏览器能指定优先级的方式是有限的：要么发起请求，要么不发起。然而
Web 页面上某些资源会比另 些更重要，这必然会加重资糠的排队效应。这是因为浏览器
为了先请求优先级高的资源，会推迟请求其他资源。但是优先级高的资源获取之后，在处
理的过程中，浏览器井不会发起新的资掘请求，所以服务器无陆利用这段时间发送优先级
低的资橱，总的页面下载时间因此延长了。还会出现这样的情况： 个高优先级资惊
被浏览器发现，但是受制于浏览器处理的方式，它被排在了 个正在获取的低优先级资惊
之后。

5. 第三方资源

虽然第 方资惊不是 HTTP/l 特有的问陋，但鉴于它日益增长的性能问题，我们也把它列
在这里。

## Web性能优化技术

### Web性能的最佳实践

1. DNS查询优化

在与服务主机建立连接之前，需要先解析域名；那么，解析越快就越好。可以从下列诀窍
开始。

2. 优化 CP连接

* 利用 econnect 指令 ，连接在使用之前就已经建立好了，这样处理流程的关键路径上就
不必考虑连接时间了。例如：

<link el ＝” econnect ef＝” ／／ fonts.exal'lple .c ol'l" crosso lgln>

* 尽早终止井响应。借助 CDN ，在距离请求用户很近的边缘端点上，请求就可以获得响应，
所以可以终止连接，大幅减少建立新连接的通信延迟。

* 实施最新的 TLS 最佳实践 优化 HTTPS

3. 避免重定向

重定向通常触发与额外域名建立连接。

4. 客户端缓存

没有什么比直接从本地缓存获取资源来得更快，因为它根本就不需要建立网络连接。俗话
说（或者至少从现在开始说），最快的请求是根本不发起请求。

5. 网络边缘的缓存因为所有用户都能从云

因为所有用户都能从云端的共享缓存受益，所以网络边缘的缓存提供了更快的访问速度，
也为网站服务基础设施分担了很大 部分流量。

6. 条件缓存

HTTP 提供条件请求机制，客户端能以有效方式询问服务器：“如果内容变了，请返回内容本身；否则，直接告诉我内容没变。

7. 压缩和代码极简化

所有的文本内容（HTML JS css SVG XML, JSON 字体等），可以从压缩和极简化中受益

8. 避免阻塞CSS/JS

css 的作用是告诉浏览器以什么方式在可视区域的哪个部分渲染内容。所以，在屏幕上绘
制第 个像素之前，浏览器必须确保 ss 已经下载完整。尽管浏览器的预处理器很智能，
会尽早请求整个页面所需要的 css ，但是把 ss 资源请求放在页面靠前的部分仍然是种最
佳实践 具体位置是在文档的 head 标签里，而且要在任何 或图片被请求和处理之前

9. 图片优化

对大多数网站而 ，图片的相对重要性和绝对重要性都在不断增加。图 3-6 展示了过去
年间每个 Web 页面的平均请求数和 节大小。

### 反模式

HπP/2 对每个域名只会开启 个连接，所以 HπP/1.1 下的 些诀窍对它来说只会适得其
反。接下来讨论几个如今流行却不再适用于 h2 站点的做峰。

1. 不需要生成精灵图和合并图片
2. 不需要域名拆分
3. 不需要禁用cookie 的域名