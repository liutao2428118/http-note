# 内容协商与转码

## 内容协商技术

共有 3 种不同的方法可以决定服务器上哪个页面最合适客户端：让客户端来选择、服务器自动判定、或让中间代理来选。

![Image text](/images/1648518237(1).png)

## 客户端驱动的协商

来客户端子自己决定，服务器收到客户端请求时只是发回响应，在其中列出可用的页面，让客户端决定要看那个，这是最容易的事情。不利之处就是每个页面都需要两次请求：第一次获取列表，第二次获取选择的副本。

## 服务器驱动的协议

有两种机制可供 HTTP 服务器评估发送什么响应给客户端比较合适：

1. 检查内容协商首部集。服务器察看客户端发送的 Accept 首部集，设法用相应的响应首部与之匹配。
2. 根据其他首部进行变通。例如，服务器可以根据客户端发送的 User-Agent 首部来发送响应。

### 内容协商首部集

![Image text](/images/1648518821(1).png)

服务器的实体首部集来匹配客户端的 Accept 首部集

![Image text](/images/1648518968(1).png)

### 内容协商首部中的质量值

HTTP 协议中定义了质量值，允许客户为每种偏好类别列出多种选项，并为每种偏好选项关联一个优先次序。

```js
Accept-Language: en;q=0.5, fr; q=0.0, nl; q=1.0, tr;q=0.0
```

## 透明协商

透明协商机制试图从服务器上去除服务器驱动所需要的负载，并用中间代理来代表客户端以使与客户端的报文交换最小化。

### 进行缓存与备用候选

和客户端与服务器之间交换一样，缓存也必须使用相同的首部集来决定回送哪个已缓存的响应。

![Image text](/images/1648519667(1).png)

### Vary 首部

HTTP 的 Vary 响应首部中列出了所用客户端请求首部，服务器可用这些首部来选择文档或产生定制的内容。

![Image text](/images/1648520193(1).png)

## 转码

服务器可以把现存的文档转换成某种客户端可用的文档。这选项称为转码。

![Image text](/images/1648520330(1).png)

### 内容注入

另一类转换会增加文档的内容，即内容注入转码。内容注入转码的例子有自动广告生成器和用户追踪系统。